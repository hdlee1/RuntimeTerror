<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Home</title>
    <!--DO NOT FORGET THIS SCRIPT TAG SO YOU CAN USE JQUERY!!!!!-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
        
    </style>

    <!--YOUR OWN JAVASCRIPT CAN GO RIGHT HERE-->
    <script type="text/javascript">
        var comments;
        function LogOff() {
            var webMethod = "ProjectServices.asmx/LogOff";
            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d) {
                        //we logged off, so go back to logon page,
                        location.href = "logon.html";
                    }
                    else {
                    }
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        function getWelcome() {
            var name = (sessionStorage.getItem("fnameLogon") + " " + sessionStorage.getItem("lnameLogon")).trim();
            document.getElementById('welcome').innerHTML = "Welcome back, " + name + "!";
        }
        function CreateComment(postID) {
            var webMethod = "ProjectServices.asmx/CreateComment";
            var comment = document.getElementById('postCommentSection' + postID).value;
            var parameters = "{\"comment\":\"" + encodeURI(comment) + "\",\"postID\":\"" + postID + "\"}";

            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                    return errorMessage;
                }
            });
        }

        function GetComments(postID) {
            var webMethod = "ProjectServices.asmx/GetComments";
            var parameters = "{\"postID\":\"" + postID + "\"}";

            $.ajax({
                type: "POST",
                url: "ProjectServices.asmx/GetComments",
                data: "{\"postID\":\"" + postID + "\"}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    comments = msg.d;
                    var id = "#postID" + postID
                    if (comments != null) {
                        for (var i = 0; i < comments.length; i++) {
                            $(id).html("<td></td><td colspan='6' class='heading'>Comments:</td>");
                            $(id).after("<tr><td></td>" +
                                
                                "<td class='comment'>" + comments[i].Comment + "</td>" +
                                "<td class='comment'>" + comments[i].DateTime + "</td>" +
                                "<td class='comment' colspan='2'>" + comments[i].FirstName + " " + comments[i].LastName + "</td>" +                               
                                "<td class='comment'>" + "<button class='commentButton' onclick='EditComment(\"" + comments[i].CommentID + "\",\"" + comments[i].Comment + "\")'>Edit</button>" + "</td>" +
                                "<td class='comment'>" + "<button class='commentButton'>Delete</button>" + "</td>" +
                                "</tr>");
                        }
                    }
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        function CreateVote(postid, like, dislike) {
            var webMethod = "ProjectServices.asmx/CreateVote";
            var parameters = "{\"postid\":\"" + encodeURI(postid) + "\", \"like\":\"" + encodeURI(like) + "\", \"dislike\":\"" + encodeURI(dislike) + "\"}";

            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    $(".likes").remove();
                    $(".dislikes").remove();
                    $(".left").remove();
                    $(".right").remove();
                    $(".postText").remove();
                    $(".buttons").remove();
                    $(".yourvote").remove();
                    $(".commentButton").remove();
                    $(".comment").remove();
                    $(".heading").remove();
                    GetPost();
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        function CreateVoteFilter(postid, like, dislike) {
            var webMethod = "ProjectServices.asmx/CreateVote";
            var parameters = "{\"postid\":\"" + encodeURI(postid) + "\", \"like\":\"" + encodeURI(like) + "\", \"dislike\":\"" + encodeURI(dislike) + "\"}";

            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    $(".likes").remove();
                    $(".dislikes").remove();
                    $(".left").remove();
                    $(".right").remove();
                    $(".postText").remove();
                    $(".buttons").remove();
                    $(".yourvote").remove();
                    $(".commentButton").remove();
                    $(".comment").remove();
                    $(".heading").remove();
                    FilterPosts();
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        function CreateVotePopularity(postid, like, dislike) {
            var webMethod = "ProjectServices.asmx/CreateVote";
            var parameters = "{\"postid\":\"" + encodeURI(postid) + "\", \"like\":\"" + encodeURI(like) + "\", \"dislike\":\"" + encodeURI(dislike) + "\"}";

            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    $(".likes").remove();
                    $(".dislikes").remove();
                    $(".left").remove();
                    $(".right").remove();
                    $(".postText").remove();
                    $(".buttons").remove();
                    $(".yourvote").remove();
                    $(".commentButton").remove();
                    $(".comment").remove();
                    $(".heading").remove();
                    FilterPostsPopular();
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        function GetPost() {
            var postsArray;
            var webMethod = "ProjectServices.asmx/GetPost";
            $.ajax({
                type: "POST",
                url: webMethod,
                cache: false,
                async: false,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d.length > 0) {
                        //put posts from server in postsArray varibale for use in other functions
                        postsArray = msg.d;

                        var feed = document.getElementById("feed");
                        var rowNum = 1;
                        for (var i = 0; i < postsArray.length; i++) {
                            var row = feed.insertRow(rowNum);
                            var cell0 = row.insertCell(0);
                            var cell1 = row.insertCell(1);
                            var cell2 = row.insertCell(2);
                            var cell3 = row.insertCell(3);
                            var cell4 = row.insertCell(4);
                            var cell5 = row.insertCell(5);
                            var cell6 = row.insertCell(6);
                            var cell7 = row.insertCell(7);
                            var cell8 = row.insertCell(8);
                            var cell9 = row.insertCell(9);

                            if (postsArray[i].userId == 6) {
                                cell0.innerHTML = "<span class='left'>" + postsArray[i].firstName + "</span>";
                            }
                            else {
                                cell0.innerHTML = "<span class='left'>" + postsArray[i].firstName + " " + postsArray[i].lastName + "</span>";
                            }
                            cell1.innerHTML = "<span class='postText'>" + postsArray[i].post + "</span>";
                            cell2.innerHTML = "<span class='right'> " + postsArray[i].date + "</span>";
                            cell3.innerHTML = "<span class='likes'>" + postsArray[i].likes + "</span>";
                            cell4.innerHTML = "<span class='dislikes'>" + postsArray[i].dislikes + "</span>";
                            cell5.innerHTML = "<span class= 'yourvote'>" + postsArray[i].yourvote + "</span>";
                            cell6.innerHTML = "<span class='buttons'> <input id='thumbsUp' height='25' width='25' type='image' onclick='CreateVote(" + postsArray[i].postId + ",1,0);' src='ThumbsUp.png' />" + "&nbsp;&nbsp; <input id='thumbsDown' height='25' width='25' type='image' onclick='CreateVote(" + postsArray[i].postId + ",0,1);' src='ThumbsDown.png' /> </span>";
                            cell7.innerHTML = "<button class='commentButton' onclick='DisplayTextbox(" + postsArray[i].postId + ");'>Add Comment</button>";
                            cell8.innerHTML = "<button style='height: 42px; width: 83px;' class='commentButton' onclick='EditPost(\"" + postsArray[i].postId + "\",\"" + postsArray[i].post + "\")'>Edit</button>";
                            cell9.innerHTML = "<button style='height: 42px; width: 83px;' class='commentButton'>Delete</button>";

                            rowNum++;

                            var row2 = feed.insertRow(rowNum);
                            row2.id = "postID" + postsArray[i].postId;
                            GetComments(postsArray[i].postId);
                            rowNum++;

                            var row3 = feed.insertRow(rowNum);
                            var cell0 = row3.insertCell(0);
                            var cell1 = row3.insertCell(1);
                            cell1.innerHTML = "<div id='comment" + postsArray[i].postId + "' style='display: none;'>" +
                                "<textarea id='postCommentSection" + postsArray[i].postId + "' style='border-radius: 15px; padding:5px;' rows = '3' cols = '40' ></textarea>" +
                                "<div style='display: inline-block;width:20%;vertical-align:top;margin-left:10px;'>" +
                                "<button class='commentButton' style ='margin-bottom: 5px;' onclick='CreateComment(" + postsArray[i].postId + ")'> Submit</button>" +
                                "<button class='commentButton' onclick='CloseComment(" + postsArray[i].postId + ");'> Cancel</button>" +
                                "</div>" +
                                "</div>";
                            rowNum++;
                        }
                    }
                },
                error: function (e) {
                    alert("failed to get posts from server");
                }
            });
            
        }

        function DisplayTextbox(postID) {
            $("#comment" + postID).show();
        }
        function CloseComment(postID) {
            $("#comment" + postID).hide();
        }

        function getWelcome() {
            var name = (sessionStorage.getItem("fnameLogon") + " " + sessionStorage.getItem("lnameLogon")).trim();
            document.getElementById('welcome').innerHTML = "Welcome back, " + name + "!";
        }


        function clearFeed() {
            var feed = document.getElementById("feed");
            // this clears the feed table from the onload or other filtered search
            for (var i = feed.rows.length; i > 1; i--) {
                feed.deleteRow(i - 1);
            }
        }

        function callFilter() {
            var filter = filterSelect.value;

            switch (filter) {
                case "newest":
                    clearFeed();
                    GetPost();
                    break;
                case "popularity":
                    clearFeed();
                    FilterPostsPopular();
                    break;
                default:
                    clearFeed();
                    FilterPosts();
                    break;
            }
        }
        function FilterPosts() {
            var filter = filterSelect.value;
            var webMethod = "ProjectServices.asmx/FilterPostsDepartment";
            var parameters = "{\"dep\":\"" + encodeURI(filter) + "\"}";
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d.length > 0) {
                        fpostsArray = msg.d;
                        clearFeed();
                        // repopulates table based on new querry
                        var rowNum = 1;
                        for (var i = 0; i < fpostsArray.length; i++) {

                            var row = feed.insertRow(rowNum);
                            var cell0 = row.insertCell(0);
                            var cell1 = row.insertCell(1);
                            var cell2 = row.insertCell(2);
                            var cell3 = row.insertCell(3);
                            var cell4 = row.insertCell(4);
                            var cell5 = row.insertCell(5);
                            var cell6 = row.insertCell(6);
                            var cell7 = row.insertCell(7);
                            var cell8 = row.insertCell(8);
                            var cell9 = row.insertCell(9);

                            if (fpostsArray[i].userId == 6) {
                                cell0.innerHTML = "<span class='left'>" + fpostsArray[i].firstName + "</span>";
                            }
                            else {
                                cell0.innerHTML = "<span class='left'>" + fpostsArray[i].firstName + " " + fpostsArray[i].lastName + "</span>";
                            }
                            cell1.innerHTML = "<span class='postText'>" + fpostsArray[i].post + "</span>";
                            cell2.innerHTML = "<span class='right'> " + fpostsArray[i].date + "</span>";
                            cell3.innerHTML = "<span class='likes'>" + fpostsArray[i].likes + "</span>";
                            cell4.innerHTML = "<span class='dislikes'>" + fpostsArray[i].dislikes + "</span>";
                            cell5.innerHTML = "<span class= 'yourvote'>" + fpostsArray[i].yourvote + "</span>";
                            cell6.innerHTML = "<span class='buttons'> <input height='25' width='25' type='image' onclick='CreateVoteFilter(" + fpostsArray[i].postId + ",1,0);' src='ThumbsUp.png' /> &nbsp;&nbsp; <input height='25' width='25' type='image' onclick='CreateVoteFilter(" + fpostsArray[i].postId + ",0,1);' src='ThumbsDown.png' /> </span>";
                            cell7.innerHTML = "<button class='commentButton' onclick='DisplayTextbox(" + fpostsArray[i].postId + ");'>Add Comment</button>"
                            cell8.innerHTML = "<button style='height: 42px; width: 83px;' class='commentButton'>Edit</button>"
                            cell9.innerHTML = "<button style='height: 42px; width: 83px;' class='commentButton'>Delete</button>"
                            rowNum++;
                        }
                    } else if (msg.d.length == 0) {
                        clearFeed();
                        // repopulates table based on new query
                        var rowNum = 1;
                        var row = feed.insertRow(rowNum);
                        var cell0 = row.insertCell(0);
                        cell0.colSpan = "6";
                        cell0.innerHTML = "<span><strong> There are no posts tagged with that department. Please choose another filter</strong></span>";

                    }
                },
                error: function (e) {
                    alert("failed to filter");
                }
            });
        }

        function FilterPostsPopular() {
            var webMethod = "ProjectServices.asmx/FilterPostsPopular";
            $.ajax({
                type: "POST",
                url: webMethod,
                cache: false,
                async: false,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d.length > 0) {
                        fpostsArray = msg.d;
                        // repopulates table based on new querry
                        var rowNum = 1;
                        for (var i = 0; i < fpostsArray.length; i++) {

                            var row = feed.insertRow(rowNum);
                            var cell0 = row.insertCell(0);
                            var cell1 = row.insertCell(1);
                            var cell2 = row.insertCell(2);
                            var cell3 = row.insertCell(3);
                            var cell4 = row.insertCell(4);
                            var cell5 = row.insertCell(5);
                            var cell6 = row.insertCell(6);
                            var cell7 = row.insertCell(7);

                            if (fpostsArray[i].userId == 6) {
                                cell0.innerHTML = "<span class='left'>" + fpostsArray[i].firstName + "</span>";
                            }
                            else {
                                cell0.innerHTML = "<span class='left'>" + fpostsArray[i].firstName + " " + fpostsArray[i].lastName + "</span>";
                            }
                            cell1.innerHTML = "<span class='postText'>" + fpostsArray[i].post + "</span>";
                            cell2.innerHTML = "<span class='right'> " + fpostsArray[i].date + "</span>";
                            cell3.innerHTML = "<span class='likes'>" + fpostsArray[i].likes + "</span>";
                            cell4.innerHTML = "<span class='dislikes'>" + fpostsArray[i].dislikes + "</span>";
                            cell5.innerHTML = "<span class= 'yourvote'>" + fpostsArray[i].yourvote + "</span>";
                            cell6.innerHTML = "<span class='buttons'> <input height='25' width='25' type='image' onclick='CreateVotePopularity(" + fpostsArray[i].postId + ",1,0);' src='ThumbsUp.png' /> &nbsp;&nbsp; <input height='25' width='25' type='image' onclick='CreateVotePopularity(" + fpostsArray[i].postId + ",0,1);' src='ThumbsDown.png' /> </span>";
                            cell7.innerHTML = "<button class='commentButton' onclick='DisplayTextbox(" + fpostsArray[i].postId + ");'>Add Comment</button>"
                            rowNum++;
                        }
                    }
                },
                error: function (e) {
                    alert("failed to filter");
                }
            });
        }
        
        function EditComment(commentID, oldComment) {
            var userID = sessionStorage.getItem("id");
            var text = prompt("Edit your comment:", oldComment);
            if (text != null) {
                newComment = text;
            } 
            var webMethod = "ProjectServices.asmx/EditComment";
            var parameters = "{\"commentID\":\"" + encodeURI(commentID) + "\", \"newCommentText\":\"" + encodeURI(newComment) + "\", \"uid\":\"" + encodeURI(userID) + "\"}";
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    location.reload();
                },
                error: function (e) {
                    alert("You cannot edit this comment");
                }
            });
        }

        function EditPost(postID, oldPost) {
            var userID = sessionStorage.getItem("id");
            var text = prompt("Edit your post:", oldPost);
            if (text != null) {
                newPost = text;
            }
            var webMethod = "ProjectServices.asmx/EditPost";
            var parameters = "{\"postID\":\"" + encodeURI(postID) + "\", \"newPostText\":\"" + encodeURI(newPost) + "\", \"uid\":\"" + encodeURI(userID) + "\"}";
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    location.reload();
                },
                error: function (e) {
                    alert("You cannot edit this post");
                }
            });
        }
    </script>
    <!--END OF YOUR OWN JAVASCRIPT-->
    <!--LINK TO PROJECT STYLE SHEET-->
    <link rel="stylesheet" href="projectStyleSheet.css" />
</head>
<body onload="GetPost(); getWelcome();">
    <!--When soultions page is linked class will need to be changed to topnav2-->
    <div class="topnav">
        <a class="active" href="userFeed.html">Problems/Suggestions Feed</a>
        <a href="postProblem.html">Post Problem/Suggestion</a>
        <!--<a href="solutions.html">Solutions</a>-->
        <a href="#" onclick="LogOff()">Log Off</a>
    </div>
    <h1 id="welcome"></h1>
    <h2 class="header">Problems & Suggestions Feed</h2>
    <hr />
    <table id="filter">
        <tr>
            <td colspan="3">
                <br />
                <label for="filterSelect">Filter By:</label>
                <select id="filterSelect" name="filterSelect" onchange="callFilter()">
                    <option value="newest">Newest to Oldest</option>
                    <option value="popularity">Popularity</option>
                    <optgroup label="Department">
                        <option value="management">Management</option>
                        <option value="finance">Finance</option>
                        <option value="accounting">Accounting</option>
                        <option value="hr">HR</option>
                        <option value="sales">Sales</option>
                        <option value="marketing">Marketing</option>
                        <option value="IT">IT</option>
                        <option value="general">General</option>
                    </optgroup>
                </select>
                <br /><br />
            </td>
        </tr>
    </table>

    <table id="feed">
        <tr class='mainHeading'>
            <td width="160">Name</td>
            <td width="480">Post</td>
            <td width="170">Date</td>
            <td width="70">Likes</td>
            <td width="70">Dislikes</td>
            <td width="100">Your Vote</td>
            <td width="100"></td>
            <td width="90"></td>
            <td width="75"></td>
            <td width="75"></td>
        </tr>
    </table>
</body>
</html>
